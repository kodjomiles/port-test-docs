name: Capture AI Feedback

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

jobs:
  capture-feedback:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/feedback')
    runs-on: ubuntu-latest
    steps:
      - name: Extract feedback
        id: extract
        run: |
          # Remove the /feedback prefix and trim whitespace
          FEEDBACK=$(echo '${{ github.event.comment.body }}' | sed 's/^\/feedback[[:space:]]*//')
          echo "feedback=$FEEDBACK" >> $GITHUB_OUTPUT
          # Also store as JSON-escaped string for the API call
          echo "feedback_json=$(echo "$FEEDBACK" | jq -Rs .)" >> $GITHUB_OUTPUT

      - name: Get Port token
        id: port-auth
        run: |
          TOKEN=$(curl -s -X POST 'https://api.getport.io/v1/auth/access_token' \
            -H 'Content-Type: application/json' \
            -d '{"clientId": "${{ secrets.PORT_CLIENT_ID }}", "clientSecret": "${{ secrets.PORT_CLIENT_SECRET }}"}' \
            | jq -r '.accessToken')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Send feedback to Port
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ steps.port-auth.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "identifier": "feedback-${{ github.event.comment.id }}",
              "title": "Feedback from ${{ github.event.comment.user.login }} on PR #${{ github.event.issue.number }}",
              "properties": {
                "raw_feedback": ${{ steps.extract.outputs.feedback_json }},
                "ai_tool": "Qodo",
                "feedback_type": "PR Review",
                "pr_url": "${{ github.event.issue.html_url }}",
                "pr_number": ${{ github.event.issue.number }},
                "author": "${{ github.event.comment.user.login }}",
                "submitted_at": "${{ github.event.comment.created_at }}",
                "analyzed": false
              },
              "relations": {
                "repository": "${{ github.repository }}"
              }
            }' \
            "https://api.getport.io/v1/blueprints/aiFeedback/entities?upsert=true"

      - name: Acknowledge feedback
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "Thanks for your feedback! It has been recorded and will help us evaluate AI tools."
